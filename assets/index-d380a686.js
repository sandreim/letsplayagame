import{W as P,A as N,w as H,a as q,c as R,K as U,b as Q}from"./polkadot-2dd106b8.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();class _{constructor(){this.api=null,this.unsubscribeBlocks=null,this.unsubscribeFinalizedBlocks=null,this.blockWindow=[],this.maxBlocksInWindow=50,this.finalizedBlockNumber=0,this.blockTimestamps=new Map,this.onBlockCallback=null}async connect(e){this.api&&(await this.api.disconnect(),this.stopBlockSubscription());const t=new P(e),n={Cell:{_enum:["Empty","X","O"]},GameState:{_enum:["InProgress","XWon","OWon","Draw"]},Game:{player_x:"AccountId",player_o:"AccountId",x_turn:"bool",board:"[Cell; 9]",state:"GameState"}};return this.api=await N.create({provider:t,noInitWarn:!0,types:n}),await this.api.isReady,this.api}async callRuntimeAPI(e,t,n=[]){if(!this.api)throw new Error("API not connected");const a=`${e}_${t}`;console.log(`Calling runtime API: ${a}`),console.log("Params:",n.map(o=>({value:o.toString(),hex:o.toHex(),u8a:Array.from(o.toU8a())})));let i="0x";if(n.length>0){const o=[];n.forEach(r=>{const c=r.toU8a();o.push(...c)}),i=this.api.createType("Bytes",o).toHex()}console.log("Encoded params (hex):",i);const s=await this.api.rpc.state.call(a,i);return console.log("Raw result:",s.toHex()),s}async disconnect(){this.api&&(await this.api.disconnect(),this.api=null),this.stopBlockSubscription()}async getChainInfo(){if(!this.api)throw new Error("Not connected to chain");const[e,t]=await Promise.all([this.api.rpc.system.chain(),this.api.rpc.system.version()]);return{chain:e.toString(),version:t.toString()}}async subscribeToBlocks(e){if(!this.api)return;this.onBlockCallback=e;let t=null;this.unsubscribeBlocks=await this.api.rpc.chain.subscribeNewHeads(n=>{let a=t!==null&&n.parentHash.toHex()!==t;t=n.hash.toHex(),a&&console.warn("‚ö†Ô∏è Possible chain revert detected"),this.updateBlockInfo(n),e&&e(a)}),this.unsubscribeFinalizedBlocks=await this.api.rpc.chain.subscribeFinalizedHeads(n=>{this.updateFinalizedBlockInfo(n)})}updateBlockInfo(e){const t=e.number.toNumber(),n=e.hash.toString(),a=Date.now();this.blockTimestamps.set(t,a),this.addBlockToWindow(t,n,!1)}updateFinalizedBlockInfo(e){const t=e.number.toNumber();this.finalizedBlockNumber=t,this.markFinalizedBlocks()}addBlockToWindow(e,t,n){if(this.blockWindow.findIndex(o=>o.number===e)!==-1)return;const i={number:e,hash:t,isFinalized:n||e<=this.finalizedBlockNumber};this.blockWindow.push(i),this.blockWindow.sort((o,r)=>r.number-o.number);const s=document.getElementById("blockWindow");if(s){const o=s.offsetWidth,d=Math.floor(o/(42+4));if(this.blockWindow.length>d){this.blockWindow=this.blockWindow.slice(0,d);const l=new Set(this.blockWindow.map(h=>h.number));for(const[h]of this.blockTimestamps)l.has(h)||this.blockTimestamps.delete(h)}}this.renderBlockWindow()}markFinalizedBlocks(){this.blockWindow.forEach(e=>{e.number<=this.finalizedBlockNumber&&(e.isFinalized=!0)}),this.renderBlockWindow()}renderBlockWindow(){const e=document.getElementById("blockWindow"),t=document.getElementById("blockTimeline");!e||!t||(e.innerHTML="",this.blockWindow.forEach((n,a)=>{const i=document.createElement("div");i.className="block-item",n.isFinalized&&i.classList.add("finalized"),a===0&&i.classList.add("new-block");const s=`${n.hash.slice(2,6)}${n.hash.slice(-2)}`;i.innerHTML=`
                <div class="block-number">${n.number}</div>
                <div class="block-hash-short">${s}</div>
            `;const o=this.blockTimestamps.get(n.number),r=o?new Date(o).toLocaleTimeString():"";i.title=`Block #${n.number.toLocaleString()}
${n.hash}
${r}
${n.isFinalized?"‚úì Finalized":"Pending"}`,e.appendChild(i)}),t.innerHTML="",this.blockWindow.forEach((n,a)=>{const i=document.createElement("div");i.className="timeline-tick";const s=this.blockTimestamps.get(n.number);let o="--";if(s&&a<this.blockWindow.length-1){const r=this.blockWindow[a+1],c=this.blockTimestamps.get(r.number);if(c){const l=((s-c)/1e3).toFixed(1);o=`${l}s`,parseFloat(l)>=10&&i.classList.add("major")}}i.innerHTML=`
                <div class="tick-mark"></div>
                <div class="tick-time">${o}</div>
            `,t.appendChild(i)}))}stopBlockSubscription(){this.unsubscribeBlocks&&(this.unsubscribeBlocks(),this.unsubscribeBlocks=null),this.unsubscribeFinalizedBlocks&&(this.unsubscribeFinalizedBlocks(),this.unsubscribeFinalizedBlocks=null)}isConnected(){return this.api!==null&&this.api.isConnected}}class D{constructor(e){this.chainManager=e,this.currentAccount=null,this.keyring=null,this.keyringPair=null,this.accountType=null,this.accountUpdateInterval=null,this.lastAccountUpdate=0,this.accountUpdateThrottle=3e3}async connectWallet(){try{if((await H("Polkadot Tic-Tac-Toe")).length===0)throw new Error("No extension installed. Please install Polkadot.js extension.");const t=await q();if(t.length===0)throw new Error("No accounts found. Please create an account in your Polkadot.js extension.");return this.currentAccount=t[0],this.accountType="extension",this.currentAccount}catch(e){throw console.error("Error connecting wallet:",e),e}}async createFromSeed(e){try{return await R(),this.keyring||(this.keyring=new U({type:"sr25519"})),this.keyringPair=this.keyring.addFromUri(e),this.currentAccount={address:this.keyringPair.address,meta:{name:"Seed Account",source:"seed"}},this.accountType="seed",this.currentAccount}catch(t){throw console.error("Error creating account from seed:",t),t}}async getBalance(){if(!this.currentAccount||!this.chainManager.api)return null;const{data:e}=await this.chainManager.api.query.system.account(this.currentAccount.address),t=this.chainManager.api.registry.chainDecimals[0]||12,n=Math.pow(10,t),a=i=>(parseFloat(i.toString())/n).toFixed(4);return{free:a(e.free),reserved:a(e.reserved),frozen:a(e.frozen)}}startBalanceUpdates(e){this.accountUpdateInterval=setInterval(async()=>{const t=Date.now();if(t-this.lastAccountUpdate>=this.accountUpdateThrottle){this.lastAccountUpdate=t;try{const n=await this.getBalance();e(n)}catch(n){console.error("Error updating balance:",n)}}},this.accountUpdateThrottle)}stopBalanceUpdates(){this.accountUpdateInterval&&(clearInterval(this.accountUpdateInterval),this.accountUpdateInterval=null)}async signAndSend(e,t){if(this.accountType==="seed")return await e.signAndSend(this.keyringPair,t);{const n=await Q(this.currentAccount.address);return await e.signAndSend(this.currentAccount.address,{signer:n.signer},t)}}async sendUnsigned(e,t){return await e.send(t)}disconnect(){this.stopBalanceUpdates(),this.currentAccount=null,this.accountType=null,this.keyringPair=null}isConnected(){return this.currentAccount!==null}getAddress(){return this.currentAccount?.address||null}}class X{constructor(e,t){this.chainManager=e,this.accountManager=t,this.gameId=null,this.isActive=!1,this.board=Array(9).fill(null),this.playerSymbol=null,this.opponentAddress=null,this.playerX=null,this.playerO=null,this.isMyTurn=!1,this.isEnded=!1,this.gameState=null,this.onStateChangeCallbacks=[]}onStateChange(e){this.onStateChangeCallbacks.push(e)}notifyStateChange(){console.log(`üîî notifyStateChange called. Callbacks: ${this.onStateChangeCallbacks.length}`),console.log("   State:",{gameId:this.gameId,isMyTurn:this.isMyTurn,playerSymbol:this.playerSymbol,isActive:this.isActive,isEnded:this.isEnded}),this.onStateChangeCallbacks.forEach((e,t)=>{try{console.log(`  Calling callback #${t}`),e(this)}catch(n){console.error(`Error in state change callback #${t}:`,n)}})}initialize(e,t,n){const a=this.accountManager.getAddress();if(a!==t&&a!==n)throw new Error("You are not a player in this game");this.gameId=e,this.playerX=t,this.playerO=n,this.playerSymbol=a===t?"X":"O",this.opponentAddress=a===t?n:t,this.isActive=!0,console.log(`Game ${e} initialized. You are Player ${this.playerSymbol}`)}async getPlayerGame(){if(!this.chainManager.api||!this.accountManager.isConnected())return null;try{const e=this.accountManager.getAddress();console.log("Fetching active game for player:",e);const t=this.chainManager.api,n=t.createType("AccountId32",e),a=await this.chainManager.callRuntimeAPI("TicTacToeApi","get_player_game",[n]),i=t.createType("Option<(u32, Game)>",a);if(i.isNone)return console.log("No active game found"),null;const[s,o]=i.unwrap();return console.log(`Found active game #${s.toNumber()}`),[s.toNumber(),o]}catch(e){throw console.error("Error fetching player game:",e),e}}async refresh(){if(!this.chainManager.api)return console.warn("Cannot refresh: API not ready"),!1;try{console.log("Refreshing game state from chain...");const e=await this.getPlayerGame();if(!e)return console.log("No active game found for player"),this.gameId!==null&&(console.log("Previous game has ended"),this.isActive=!1,this.isEnded=!0),!1;const[t,n]=e;console.log(`Refreshing game #${t} from chain:`,n.toHuman()),this.gameId!==t&&(console.log(`Game ID changed from ${this.gameId} to ${t}, re-initializing`),this.initialize(t,n.player_x.toString(),n.player_o.toString())),this.updateBoard(n.board);const a=n.x_turn!==void 0?n.x_turn:n.xTurn,i=this.isMyTurn;console.log("üîÑ Turn data from chain:",{"gameData.x_turn":n.x_turn,"gameData.xTurn":n.xTurn,"resolved xTurn":a,"xTurn type":typeof a,"xTurn.valueOf()":a?.valueOf?a.valueOf():a,playerSymbol:this.playerSymbol,oldIsMyTurn:i});const s=a?.valueOf?a.valueOf():!!a;this.isMyTurn=this.playerSymbol==="X"&&s||this.playerSymbol==="O"&&!s,console.log("Turn calculation result:",{xTurnBool:s,playerSymbol:this.playerSymbol,oldIsMyTurn:i,newIsMyTurn:this.isMyTurn,"newIsMyTurn type":typeof this.isMyTurn,changed:i!==this.isMyTurn});const o=n.state;return this.gameState=o,o.isInProgress||(this.isActive=!1,this.isEnded=!0,console.log("Game has ended:",o.toHuman())),console.log(`‚úì Refreshed game #${this.gameId}:`,{board:this.board,isMyTurn:this.isMyTurn,isEnded:this.isEnded,state:this.gameState?.toHuman()}),this.notifyStateChange(),!0}catch(e){return console.error("Error refreshing game state:",e),!1}}updateBoard(e){const t=Array(9).fill(null);e.forEach((n,a)=>{const i=this.decodeCellValue(n);i&&(t[a]=i)}),this.board=t,console.log("Board updated:",t)}decodeCellValue(e){return e.isX||e.toHuman?.()==="X"||e.toJSON?.()==="X"?"X":e.isO||e.toHuman?.()==="O"||e.toJSON?.()==="O"?"O":null}async handleEvent(e,t){switch(console.log(`üéÆ GameState handling event: ${e}`,t),e){case"gameCreated":const n=this.accountManager.getAddress();(t.playerX===n||t.playerO===n)&&(console.log("New game created for us, refreshing state..."),await this.refresh());break;case"moveMade":console.log("Move made, refreshing state..."),await this.refresh();break;case"gameEnded":console.log("Game ended, marking as inactive"),this.isActive=!1,this.isEnded=!0,this.notifyStateChange();break}}reset(){this.gameId=null,this.isActive=!1,this.board=Array(9).fill(null),this.playerSymbol=null,this.opponentAddress=null,this.playerX=null,this.playerO=null,this.isMyTurn=!1,this.isEnded=!1,this.gameState=null,console.log("Game state reset"),this.notifyStateChange()}toJSON(){return{gameId:this.gameId,isActive:this.isActive,isEnded:this.isEnded,board:this.board,playerSymbol:this.playerSymbol,opponentAddress:this.opponentAddress,playerX:this.playerX,playerO:this.playerO,isMyTurn:this.isMyTurn,gameState:this.gameState?.toHuman?.()||this.gameState}}}class J{constructor(e,t){this.chainManager=e,this.accountManager=t,this.gameState=new X(e,t),this.eventsSubscribed=!1,this.gameStats={xWins:0,oWins:0,draws:0},this.loadGameStats()}async getPlayerGame(){return await this.gameState.getPlayerGame()}async setupGame(e,t,n,a=null){try{if(console.log("setupGame called with:",{gameId:e,playerX:t,playerO:n,hasExistingData:!!a}),this.gameState.initialize(e,t,n),await this.gameState.refresh(),console.log("‚úì Game setup complete:",this.gameState.toJSON()),this.gameState.isEnded){const i=this.gameState.gameState,s=i.toHuman();if(s==="XWon"||i.isXWon)return{ended:!0,state:1};if(s==="OWon"||i.isOWon)return{ended:!0,state:2};if(s==="Draw"||i.isDraw)return{ended:!0,state:3}}return{ended:!1}}catch(i){throw console.error("Error setting up game:",i),i}}async makeMove(e){if(!this.chainManager.api||!this.accountManager.isConnected())throw new Error("Not connected to chain or wallet");return console.log(`Making on-chain move: game ${this.gameState.gameId}, position ${e}`),this.chainManager.api.tx.ticTacToe.makeMove(this.gameState.gameId,e)}async claimTimeout(){if(!this.chainManager.api||!this.accountManager.isConnected())throw new Error("Not connected to chain or wallet");if(this.gameState.gameId===null||this.gameState.gameId===void 0)throw new Error("No active game");return console.log(`Claiming timeout victory for game ${this.gameState.gameId}`),this.chainManager.api.tx.ticTacToe.claimTimeout(this.gameState.gameId)}handleGameEnd(e){this.gameState.isActive=!1,this.gameState.isEnded=!0;let t="",n=null;switch(e){case 1:t="üéâ Player X wins!",n="winner",this.gameState.playerSymbol==="X"&&this.gameStats.xWins++;break;case 2:t="üéâ Player O wins!",n="winner",this.gameState.playerSymbol==="O"&&this.gameStats.oWins++;break;case 3:t="ü§ù It's a draw!",n="draw",this.gameStats.draws++;break}return this.saveGameStats(),this.gameState.notifyStateChange(),{message:t,winnerType:n,stats:this.gameStats}}resetGame(){this.gameState.reset(),this.eventsSubscribed=!1}subscribeToGameEvents(e){if(this.eventsSubscribed||!this.chainManager.api){console.log("Events already subscribed or API not ready");return}console.log("Subscribing to game events..."),this.eventsSubscribed=!0,this.chainManager.api.query.system.events(async t=>{for(const{event:n}of t)if(this.chainManager.api.events.ticTacToe.MoveMade.is(n)){const[a,i,s]=n.data;a.toNumber()===this.gameState.gameId&&(console.log(`Move made in game ${a} by ${i} at position ${s}`),e("moveMade",{gameId:a.toNumber()}))}t.forEach(({event:n})=>{if(this.chainManager.api.events.ticTacToe.GameCreated.is(n)){const[a,i,s]=n.data;e("gameCreated",{gameId:a.toNumber(),playerX:i.toString(),playerO:s.toString()})}if(this.chainManager.api.events.ticTacToe.GameEnded.is(n)){const[a,i]=n.data;a.toNumber()===this.gameState.gameId&&(console.log(`Current game ${a} ended with state: ${i}`),e("gameEnded",{gameId:a.toNumber(),state:i.toNumber()}))}})})}saveGameStats(){localStorage.setItem("tictactoe_stats",JSON.stringify(this.gameStats))}loadGameStats(){const e=localStorage.getItem("tictactoe_stats");if(e)try{this.gameStats=JSON.parse(e)}catch(t){console.error("Error loading game stats:",t)}}getGameInfo(){return{currentGameId:this.gameState.gameId,currentPlayerSymbol:this.gameState.playerSymbol,opponentAddress:this.gameState.opponentAddress,gameActive:this.gameState.isActive,gameBoard:this.gameState.board,gameStats:this.gameStats}}}class j{constructor(e,t){this.chainManager=e,this.accountManager=t,this.inQueue=!1}async joinQueue(){if(!this.chainManager.api||!this.accountManager.isConnected())throw new Error("Not connected to chain or wallet");return console.log("Joining matchmaking queue..."),this.inQueue=!0,this.chainManager.api.tx.ticTacToe.playGame()}async cancelQueue(){if(!this.chainManager.api||!this.accountManager.isConnected())throw new Error("Not connected to chain or wallet");return console.log("Canceling matchmaking..."),this.inQueue=!1,this.chainManager.api.tx.ticTacToe.cancelMatchmaking()}isInQueue(){return this.inQueue}setInQueue(e){this.inQueue=e}async isPlayerInQueue(){if(!this.chainManager.api||!this.accountManager.isConnected())return!1;try{const e=await this.chainManager.api.query.ticTacToe.matchmakingQueue(),t=this.accountManager.getAddress(),n=e.some(a=>a.toString()===t);return this.inQueue=n,console.log("Player in queue:",n),n}catch(e){return console.error("Error checking queue status:",e),!1}}}class Y{constructor(){this.transactionHistory=[],this.pendingTransactions=new Map,this.timingChart=null}createTransaction(e,t,n,a){return{id:`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,from:t,to:n,amount:a,status:"pending",statusText:"Signing...",hash:null,blockHash:null,timing:{submitted:Date.now(),ready:null,broadcast:null,inBlock:null,finalized:null,invalid:null}}}addToHistory(e){return this.transactionHistory.unshift(e),this.transactionHistory.length>50&&(this.transactionHistory=this.transactionHistory.slice(0,50)),e.status==="pending"&&e.hash&&this.pendingTransactions.set(e.hash,e),this.transactionHistory}updateInHistory(e,t){const n=this.transactionHistory.find(a=>a.hash===e||a.id===e);return n&&(Object.assign(n,t),t.status!=="pending"&&n.hash&&this.pendingTransactions.delete(n.hash)),this.transactionHistory}clearHistory(){this.transactionHistory=[],this.pendingTransactions.clear()}getHistory(){return this.transactionHistory}getPendingCount(){return this.pendingTransactions.size}calculateStats(){console.log("Calculating stats from",this.transactionHistory.length,"total transactions");const e=[],t=[],n=[];if(this.transactionHistory.forEach(o=>{o.timing.ready&&e.push(o.timing.ready-o.timing.submitted),o.timing.inBlock&&t.push(o.timing.inBlock-o.timing.submitted),o.timing.finalized&&n.push(o.timing.finalized-o.timing.submitted)}),console.log("Stats data:",{ready:e.length,inBlock:t.length,finalized:n.length}),e.length===0&&t.length===0&&n.length===0)return console.log("No timing data available for stats"),null;const a=o=>o.length>0?o.reduce((r,c)=>r+c,0)/o.length:0,i=o=>o.length>0?Math.min(...o):0,s=o=>o.length>0?Math.max(...o):0;return{ready:{min:i(e),max:s(e),avg:a(e),count:e.length},inBlock:{min:i(t),max:s(t),avg:a(t),count:t.length},finalized:{min:i(n),max:s(n),avg:a(n),count:n.length}}}}class K{constructor(e){this.gameManager=e,this.elements=this.cacheElements(),this.previousBoard=Array(9).fill(null),this.gameManager.gameState.onStateChange(t=>{this.updateGameUI(t)}),this.elements.errorModalOkBtn.addEventListener("click",()=>{this.hideGameMessage()}),this.elements.errorModal.addEventListener("click",t=>{(t.target===this.elements.errorModal||t.target.classList.contains("modal-overlay"))&&this.hideGameMessage()})}updateGameUI(e){if(console.log("üé® updateGameUI called with state:",e.toJSON()),e.gameId===null||e.gameId===void 0){console.log("No game ID, skipping UI update");return}this.updateBoardFromState(e),this.updatePlayerTurnFromState(e),e.isEnded&&(console.log("‚è±Ô∏è Game ended, hiding timeout section"),this.hideTimeoutSection()),console.log("‚úÖ UI update complete")}updateBoardFromState(e){const t=e.board;console.log("Updating board from state:",t);let n=!1;if(t.forEach((a,i)=>{const s=document.querySelector(`[data-cell="${i}"]`);if(!s){console.error(`Cell element not found for index ${i}`);return}const o=this.previousBoard[i]===null&&a!==null;o&&(n=!0),s.textContent="",s.classList.remove("taken","x","o","blood-splash"),a==="X"?(s.textContent="X",s.classList.add("taken","x"),o&&(s.classList.add("blood-splash"),setTimeout(()=>{s.classList.remove("blood-splash")},2500))):a==="O"&&(s.textContent="O",s.classList.add("taken","o"),o&&(s.classList.add("blood-splash"),setTimeout(()=>{s.classList.remove("blood-splash")},2500)))}),this.highlightWinningLine(t),n){const a=this.elements.gameBoard;a.classList.add("shake"),setTimeout(()=>{a.classList.remove("shake")},250)}this.previousBoard=[...t]}highlightWinningLine(e){const t=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];document.querySelectorAll(".cell.winner").forEach(n=>{n.classList.remove("winner")});for(const n of t){const[a,i,s]=n;if(e[a]&&e[a]===e[i]&&e[a]===e[s]){const o=document.querySelector(`[data-cell="${a}"]`),r=document.querySelector(`[data-cell="${i}"]`),c=document.querySelector(`[data-cell="${s}"]`);o&&o.classList.add("winner"),r&&r.classList.add("winner"),c&&c.classList.add("winner"),console.log(`üèÜ Winning line found: ${e[a]} at positions [${a}, ${i}, ${s}]`);break}}}updatePlayerTurnFromState(e){console.log("üìù updatePlayerTurnFromState called with:",{playerSymbol:e.playerSymbol,isMyTurn:e.isMyTurn,isActive:e.isActive,isEnded:e.isEnded});const t=this.elements.currentPlayer;if(!t){console.error("‚ùå Player indicator element not found!");return}if(!e.playerSymbol){console.warn("‚ö†Ô∏è Player symbol not set");return}e.isEnded===!0?t.textContent="Game over":t.textContent=e.isMyTurn?`You are ${e.playerSymbol} - Your turn!`:`You are ${e.playerSymbol} - Opponent's turn...`,t.className=`player-indicator player-${e.playerSymbol.toLowerCase()}`,console.log("‚úÖ Player turn updated successfully")}cacheElements(){return{rpcUrl:document.getElementById("rpcUrl"),connectBtn:document.getElementById("connectBtn"),connectionStatus:document.getElementById("connectionStatus"),statusIndicator:document.getElementById("statusIndicator"),statusText:document.getElementById("statusText"),chainInfo:document.getElementById("chainInfo"),chainName:document.getElementById("chainName"),chainVersion:document.getElementById("chainVersion"),connectWalletBtn:document.getElementById("connectWalletBtn"),useSeedBtn:document.getElementById("useSeedBtn"),seedInput:document.getElementById("seedInput"),seedPhrase:document.getElementById("seedPhrase"),importSeedBtn:document.getElementById("importSeedBtn"),cancelSeedBtn:document.getElementById("cancelSeedBtn"),accountType:document.getElementById("accountType"),accountInfo:document.getElementById("accountInfo"),accountAddress:document.getElementById("accountAddress"),accountBalance:document.getElementById("accountBalance"),playGameBtn:document.getElementById("playGameBtn"),cancelMatchmakingBtn:document.getElementById("cancelMatchmakingBtn"),matchmakingStatus:document.getElementById("matchmakingStatus"),gameBoard:document.getElementById("gameBoard"),gameBoardContainer:document.getElementById("gameBoardContainer"),gameModeSection:document.getElementById("gameModeSection"),gameIdDisplay:document.getElementById("gameIdDisplay"),gameIdValue:document.getElementById("gameIdValue"),playerXAddress:document.getElementById("playerXAddress"),playerOAddress:document.getElementById("playerOAddress"),gameInfoSection:document.getElementById("gameInfoSection"),currentPlayer:document.getElementById("currentPlayer"),gameMessage:document.getElementById("gameMessage"),resetGameBtn:document.getElementById("resetGameBtn"),gameStatsBottom:document.getElementById("gameStatsBottom"),xWins:document.getElementById("xWins"),oWins:document.getElementById("oWins"),draws:document.getElementById("draws"),timeoutSection:document.getElementById("timeoutSection"),timeoutTimer:document.getElementById("timeoutTimer"),timeoutCountdown:document.getElementById("timeoutCountdown"),claimTimeoutBtn:document.getElementById("claimTimeoutBtn"),gameWaitingOverlay:document.getElementById("gameWaitingOverlay"),transactionHistory:document.getElementById("transactionHistory"),clearHistoryBtn:document.getElementById("clearHistoryBtn"),pendingCount:document.getElementById("pendingCount"),timingChart:document.getElementById("timingChart"),statsContent:document.getElementById("statsContent"),minReady:document.getElementById("minReady"),maxReady:document.getElementById("maxReady"),avgReady:document.getElementById("avgReady"),minInBlock:document.getElementById("minInBlock"),maxInBlock:document.getElementById("maxInBlock"),avgInBlock:document.getElementById("avgInBlock"),minFinalized:document.getElementById("minFinalized"),maxFinalized:document.getElementById("maxFinalized"),avgFinalized:document.getElementById("avgFinalized"),blockBanner:document.getElementById("blockBanner"),blockWindow:document.getElementById("blockWindow"),errorModal:document.getElementById("errorModal"),errorModalMessage:document.getElementById("errorModalMessage"),errorModalOkBtn:document.getElementById("errorModalOkBtn")}}updateConnectionStatus(e,t){this.elements.statusText.textContent=t,e?this.elements.statusIndicator.classList.add("connected"):this.elements.statusIndicator.classList.remove("connected")}showChainInfo(e,t){this.elements.chainName.textContent=e,this.elements.chainVersion.textContent=t,this.elements.chainInfo.classList.remove("hidden")}hideChainInfo(){this.elements.chainInfo.classList.add("hidden")}showSeedInput(){this.elements.seedInput.classList.remove("hidden")}hideSeedInput(){this.elements.seedInput.classList.add("hidden"),this.elements.seedPhrase.value=""}updateAccountInfo(e,t){this.elements.accountAddress.textContent=e,this.elements.accountType.textContent=t==="seed"?"üîë Seed Account":"ü¶ä Extension Account",this.elements.accountInfo.classList.remove("hidden")}updateBalance(e){this.elements.accountBalance.textContent=`Balance: ${e.free} UNIT`}hideAccountInfo(){this.elements.accountInfo.classList.add("hidden")}showMatchmakingWaiting(){this.elements.playGameBtn.classList.add("hidden"),this.elements.cancelMatchmakingBtn.classList.remove("hidden"),this.elements.matchmakingStatus.classList.remove("hidden")}hideMatchmakingWaiting(){this.elements.playGameBtn.classList.remove("hidden"),this.elements.playGameBtn.disabled=!1,this.elements.playGameBtn.textContent="START GAME",this.elements.cancelMatchmakingBtn.classList.add("hidden"),this.elements.matchmakingStatus.classList.add("hidden")}showGameBoard(){this.elements.gameBoardContainer.classList.remove("hidden"),this.elements.gameInfoSection.classList.remove("hidden"),this.elements.gameStatsBottom.classList.remove("hidden"),this.elements.gameModeSection.style.display="none"}hideGameBoard(){this.elements.gameBoardContainer.classList.add("hidden"),this.elements.gameInfoSection.classList.add("hidden"),this.elements.gameStatsBottom.classList.add("hidden"),this.elements.gameIdDisplay.classList.add("hidden"),this.elements.gameModeSection.style.display="block"}updateGameInfo(e,t,n){this.elements.gameIdValue.textContent=e;const a=this.gameManager.accountManager.getAddress(),i=t===a?`YOU (${this.shortenAddress(t)})`:this.shortenAddress(t),s=n===a?`YOU (${this.shortenAddress(n)})`:this.shortenAddress(n);this.elements.playerXAddress.textContent=i,this.elements.playerOAddress.textContent=s,this.elements.gameIdDisplay.classList.remove("hidden")}showGameEndMessage(e,t){this.elements.gameMessage.textContent=e,this.elements.gameMessage.className=`game-message ${t}`,this.elements.gameMessage.classList.remove("hidden")}hideGameMessage(){this.elements.gameMessage.classList.add("hidden")}updateGameStats(e){this.elements.xWins.textContent=e.xWins,this.elements.oWins.textContent=e.oWins,this.elements.draws.textContent=e.draws}showTimeoutSection(){this.elements.timeoutSection.classList.remove("hidden")}hideTimeoutSection(){this.elements.timeoutSection.classList.add("hidden")}updateTimeoutCountdown(e){this.elements.timeoutCountdown.textContent=e}showClaimTimeoutBtn(){this.elements.claimTimeoutBtn.classList.remove("hidden")}hideClaimTimeoutBtn(){this.elements.claimTimeoutBtn.classList.add("hidden")}showGameWaitingOverlay(){this.elements.gameWaitingOverlay&&this.elements.gameWaitingOverlay.classList.remove("hidden")}hideGameWaitingOverlay(){this.elements.gameWaitingOverlay&&this.elements.gameWaitingOverlay.classList.add("hidden")}renderTransactionHistory(e){if(e.length===0){this.elements.transactionHistory.innerHTML='<p class="no-transactions">No transactions yet. Send your first transaction to see it here!</p>';return}this.elements.transactionHistory.innerHTML=e.map(t=>{const n=t.status,a=this.formatTiming(t.timing);return`
                <div class="tx-item ${n}">
                    <div class="tx-header">
                        <div class="tx-status">${t.statusText}</div>
                        <div class="tx-time">${new Date(t.timing.submitted).toLocaleTimeString()}</div>
                    </div>
                    <div class="tx-details">
                        <div><strong>From:</strong> ${this.shortenAddress(t.from)}</div>
                        <div><strong>To:</strong> ${t.to}</div>
                        <div><strong>Action:</strong> ${t.amount}</div>
                        ${t.hash?`<div><strong>Hash:</strong> <span class="tx-hash">${this.shortenHash(t.hash)}</span></div>`:""}
                    </div>
                    ${a?`<div class="tx-timing">${a}</div>`:""}
                </div>
            `}).join("")}updatePendingCount(e){e>0?(this.elements.pendingCount.textContent=`‚è≥ ${e} pending`,this.elements.pendingCount.classList.remove("hidden")):this.elements.pendingCount.classList.add("hidden")}initializeChart(){if(this.chart){console.log("Chart already initialized");return}if(!this.elements.timingChart){console.error("Chart canvas element not found");return}if(typeof Chart>"u"){console.error("Chart.js library not loaded yet");return}try{console.log("Initializing transaction timing chart...");const e=this.elements.timingChart.getContext("2d");this.chart=new Chart(e,{type:"line",data:{labels:[],datasets:[{label:"Ready",data:[],borderColor:"rgb(75, 192, 192)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2,tension:.1,spanGaps:!0},{label:"InBlock",data:[],borderColor:"rgb(255, 159, 64)",backgroundColor:"rgba(255, 159, 64, 0.2)",borderWidth:2,tension:.1,spanGaps:!0},{label:"Finalized",data:[],borderColor:"rgb(153, 102, 255)",backgroundColor:"rgba(153, 102, 255, 0.2)",borderWidth:2,tension:.1,spanGaps:!0}]},options:{responsive:!0,maintainAspectRatio:!0,aspectRatio:2,plugins:{legend:{position:"top",labels:{color:"#c5d9c5"}},title:{display:!0,text:"Transaction Timing (ms)",color:"#c5d9c5"}},scales:{y:{beginAtZero:!0,ticks:{color:"#c5d9c5"},grid:{color:"rgba(197, 217, 197, 0.1)"}},x:{ticks:{color:"#c5d9c5"},grid:{color:"rgba(197, 217, 197, 0.1)"}}}}}),console.log("‚úÖ Chart initialized successfully")}catch(e){console.error("Failed to initialize chart:",e),this.chart=null}}updateChart(e){if(console.log("üìä updateChart called with",e.length,"transactions"),this.chart||(console.log("Chart not initialized, initializing now..."),this.initializeChart()),!this.chart){console.warn("Chart initialization failed, cannot update");return}const t=e.filter(o=>o.timing.ready).slice(0,20).reverse();if(console.log("Found",t.length,"transactions with timing data for chart"),t.length===0){console.log("No transactions with timing data to display"),this.chart.data.labels=[],this.chart.data.datasets[0].data=[],this.chart.data.datasets[1].data=[],this.chart.data.datasets[2].data=[],this.chart.update();return}const n=t.map((o,r)=>`TX ${r+1}`),a=t.map(o=>o.timing.ready?o.timing.ready-o.timing.submitted:null),i=t.map(o=>o.timing.inBlock?o.timing.inBlock-o.timing.submitted:null),s=t.map(o=>o.timing.finalized?o.timing.finalized-o.timing.submitted:null);console.log("Chart data:",{labels:n,ready:a.filter(o=>o!==null).length+" values",inBlock:i.filter(o=>o!==null).length+" values",finalized:s.filter(o=>o!==null).length+" values"}),this.chart.data.labels=n,this.chart.data.datasets[0].data=a,this.chart.data.datasets[1].data=i,this.chart.data.datasets[2].data=s,this.chart.update(),console.log("‚úÖ Chart updated")}updateTransactionStats(e){if(console.log("üìà updateTransactionStats called with:",e),!e){console.log("No stats available, hiding stats section"),this.elements.statsContent.classList.add("hidden");return}this.elements.statsContent.classList.remove("hidden");const t=(n,a)=>a===0?"-":`${Math.round(n)}ms`;this.elements.minReady.textContent=t(e.ready.min,e.ready.count),this.elements.maxReady.textContent=t(e.ready.max,e.ready.count),this.elements.avgReady.textContent=t(e.ready.avg,e.ready.count),this.elements.minInBlock.textContent=t(e.inBlock.min,e.inBlock.count),this.elements.maxInBlock.textContent=t(e.inBlock.max,e.inBlock.count),this.elements.avgInBlock.textContent=t(e.inBlock.avg,e.inBlock.count),this.elements.minFinalized.textContent=t(e.finalized.min,e.finalized.count),this.elements.maxFinalized.textContent=t(e.finalized.max,e.finalized.count),this.elements.avgFinalized.textContent=t(e.finalized.avg,e.finalized.count),console.log("‚úÖ Stats updated:",{ready:e.ready.count,inBlock:e.inBlock.count,finalized:e.finalized.count})}showBlockBanner(){this.elements.blockBanner.classList.remove("hidden")}updateBlockWindow(e,t){this.elements.blockWindow.innerHTML=e.map(n=>`
                <div class="block-item ${n.number<=t?"finalized":""} new-block">
                    <div class="block-number">#${n.number}</div>
                    <div class="block-hash-short">${n.hash.slice(0,8)}...</div>
                </div>
            `).join("")}shortenAddress(e){return e?e.length<16?e:`${e.slice(0,6)}...${e.slice(-6)}`:"-"}shortenHash(e){return e?`${e.slice(0,10)}...${e.slice(-8)}`:"-"}formatTiming(e){const t=[];return e.ready&&t.push(`Ready: ${e.ready-e.submitted}ms`),e.inBlock&&t.push(`InBlock: ${e.inBlock-e.submitted}ms`),e.finalized&&t.push(`Finalized: ${e.finalized-e.submitted}ms`),t.join(" | ")}showGameMessage(e){console.log("üö® Showing modal message:",e),this.elements.errorModalMessage.textContent=e,this.elements.errorModal.classList.remove("hidden"),this.elements.errorModalOkBtn.focus()}hideGameMessage(){console.log("‚úÖ Hiding modal message"),this.elements.errorModal.classList.add("hidden")}}class Z{constructor(){this.audioContext=null,this.enabled=!0,this.volume=.5,this.musicEnabled=!1,this.backgroundMusic=null,this.initAudioContext()}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.error("Web Audio API not supported:",e),this.enabled=!1}}async resume(){this.audioContext&&this.audioContext.state==="suspended"&&await this.audioContext.resume()}playMoveSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),n=this.audioContext.createOscillator(),a=this.audioContext.createGain();t.connect(a),n.connect(a),a.connect(this.audioContext.destination),t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(200,e+.1),n.frequency.setValueAtTime(1200,e),n.frequency.exponentialRampToValueAtTime(300,e+.1),t.type="square",n.type="sawtooth",a.gain.setValueAtTime(this.volume*.5,e),a.gain.exponentialRampToValueAtTime(.01,e+.2),t.start(e),n.start(e),t.stop(e+.2),n.stop(e+.2)}playWinSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime;[220,277,330,440].forEach((t,n)=>{const a=this.audioContext.createOscillator(),i=this.audioContext.createGain(),s=this.audioContext.createBiquadFilter();a.connect(s),s.connect(i),i.connect(this.audioContext.destination),a.frequency.setValueAtTime(t*.5,e),a.frequency.exponentialRampToValueAtTime(t,e+.3),a.type="sawtooth",s.type="lowpass",s.frequency.setValueAtTime(400,e),s.frequency.exponentialRampToValueAtTime(2e3,e+.8);const o=n*.05;i.gain.setValueAtTime(0,e+o),i.gain.linearRampToValueAtTime(this.volume*.4,e+o+.1),i.gain.exponentialRampToValueAtTime(.01,e+o+1.2),a.start(e+o),a.stop(e+o+1.2)})}playLoseSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),n=this.audioContext.createOscillator(),a=this.audioContext.createGain(),i=this.audioContext.createBiquadFilter();t.connect(i),n.connect(i),i.connect(a),a.connect(this.audioContext.destination),t.frequency.setValueAtTime(110,e),t.frequency.exponentialRampToValueAtTime(55,e+1.5),n.frequency.setValueAtTime(165,e),n.frequency.exponentialRampToValueAtTime(82.5,e+1.5),t.type="sawtooth",n.type="triangle",i.type="lowpass",i.frequency.setValueAtTime(800,e),i.frequency.exponentialRampToValueAtTime(100,e+1.5),i.Q.setValueAtTime(5,e),a.gain.setValueAtTime(this.volume*.6,e),a.gain.exponentialRampToValueAtTime(.01,e+1.5),t.start(e),n.start(e),t.stop(e+1.5),n.stop(e+1.5)}playMatchmakingSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.sampleRate*.5,n=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),a=n.getChannelData(0);for(let r=0;r<t;r++)a[r]=Math.random()*2-1;const i=this.audioContext.createBufferSource();i.buffer=n;const s=this.audioContext.createBiquadFilter();s.type="bandpass",s.frequency.setValueAtTime(1e3,e),s.frequency.exponentialRampToValueAtTime(2e3,e+.5),s.Q.setValueAtTime(10,e);const o=this.audioContext.createGain();o.gain.setValueAtTime(this.volume*.3,e),o.gain.exponentialRampToValueAtTime(.01,e+.5),i.connect(s),s.connect(o),o.connect(this.audioContext.destination),i.start(e),i.stop(e+.5)}playTimeoutWarning(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),n=this.audioContext.createGain();t.connect(n),n.connect(this.audioContext.destination),t.frequency.setValueAtTime(1200,e),t.frequency.exponentialRampToValueAtTime(800,e+.01),t.type="square",n.gain.setValueAtTime(this.volume*.4,e),n.gain.exponentialRampToValueAtTime(.01,e+.05),t.start(e),t.stop(e+.05)}playGameStartSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),n=this.audioContext.createOscillator(),a=this.audioContext.createGain(),i=this.audioContext.createBiquadFilter();t.connect(i),n.connect(i),i.connect(a),a.connect(this.audioContext.destination),t.frequency.setValueAtTime(55,e),n.frequency.setValueAtTime(58,e),t.type="sine",n.type="sine",i.type="lowpass",i.frequency.setValueAtTime(200,e),a.gain.setValueAtTime(0,e),a.gain.linearRampToValueAtTime(this.volume*.5,e+.3),a.gain.exponentialRampToValueAtTime(.01,e+2),t.start(e),n.start(e),t.stop(e+2),n.stop(e+2)}playOpponentTurnSound(){if(!this.enabled||!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),n=this.audioContext.createGain(),a=this.audioContext.createBiquadFilter();t.connect(a),a.connect(n),n.connect(this.audioContext.destination),t.frequency.setValueAtTime(440,e),t.frequency.linearRampToValueAtTime(660,e+.05),t.frequency.linearRampToValueAtTime(440,e+.1),t.type="triangle",a.type="highpass",a.frequency.setValueAtTime(300,e),n.gain.setValueAtTime(this.volume*.3,e),n.gain.exponentialRampToValueAtTime(.01,e+.15),t.start(e),t.stop(e+.15)}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.backgroundMusic&&this.backgroundMusic.gainNode&&this.backgroundMusic.gainNode.gain.setValueAtTime(this.volume*.15,this.audioContext.currentTime)}toggleEnabled(){return this.enabled=!this.enabled,!this.enabled&&this.backgroundMusic&&this.stopBackgroundMusic(),this.enabled}isEnabled(){return this.enabled}async startBackgroundMusic(){if(!this.musicEnabled||!this.audioContext||this.backgroundMusic)return;console.log("üéµ Starting background music...");const e="/music/horror-ambient.mp3";try{const t=await fetch(e);if(t.ok){const n=await t.arrayBuffer(),a=await this.audioContext.decodeAudioData(n),i=this.audioContext.createBufferSource();i.buffer=a,i.loop=!0;const s=this.audioContext.createGain();s.gain.setValueAtTime(this.volume*.3,this.audioContext.currentTime),i.connect(s),s.connect(this.audioContext.destination),i.start(0),this.backgroundMusic={source:i,gainNode:s},console.log("‚úÖ Background music loaded from file");return}}catch(t){console.warn("Could not load audio file, using synthesized music:",t)}this.startSynthesizedMusic()}startSynthesizedMusic(){try{const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),a=e.createOscillator(),i=e.createOscillator(),s=e.createBiquadFilter(),o=e.createGain();n.type="sawtooth",n.frequency.setValueAtTime(65.41,t),a.type="sawtooth",a.frequency.setValueAtTime(65.41*2,t),i.type="sine",i.frequency.setValueAtTime(65.41*3,t),s.type="bandpass",s.frequency.setValueAtTime(800,t),s.Q.setValueAtTime(2,t),n.connect(s),a.connect(s),i.connect(s),s.connect(o),o.gain.setValueAtTime(.15,t);const r=e.createOscillator(),c=e.createOscillator(),d=e.createOscillator(),l=e.createBiquadFilter(),h=e.createGain();r.type="sine",r.frequency.setValueAtTime(87.31,t),c.type="sine",c.frequency.setValueAtTime(87.31*2,t),d.type="sine",d.frequency.setValueAtTime(87.31*4,t),l.type="lowpass",l.frequency.setValueAtTime(1200,t),l.Q.setValueAtTime(1,t),r.connect(l),c.connect(l),d.connect(l),l.connect(h),h.gain.setValueAtTime(.12,t);const y=e.sampleRate*4,$=e.createBuffer(1,y,e.sampleRate),F=$.getChannelData(0);for(let m=0;m<y;m++){const v=Math.exp(-m/(e.sampleRate*.8)),f=(Math.random()*2-1)*.3,z=Math.sin(2*Math.PI*58*m/e.sampleRate);F[m]=(z*.7+f*.3)*v}const M=e.createBufferSource();M.buffer=$,M.loop=!0;const T=e.createBiquadFilter();T.type="lowpass",T.frequency.setValueAtTime(120,t),T.Q.setValueAtTime(3,t);const A=e.createGain();A.gain.setValueAtTime(.08,t),M.connect(T),T.connect(A);const b=e.createOscillator(),B=e.createOscillator(),k=e.createOscillator(),p=e.createBiquadFilter(),w=e.createGain();b.type="triangle",b.frequency.setValueAtTime(196,t),B.type="sine",B.frequency.setValueAtTime(196*1.5,t),k.type="sine",k.frequency.setValueAtTime(196*.75,t),p.type="bandpass",p.frequency.setValueAtTime(900,t),p.Q.setValueAtTime(4,t),b.connect(p),B.connect(p),k.connect(p),p.connect(w),w.gain.setValueAtTime(.06,t);const g=e.createGain(),E=e.createGain(),x=e.createDynamicsCompressor(),V=e.createBuffer(2,e.sampleRate*3,e.sampleRate);for(let m=0;m<2;m++){const v=V.getChannelData(m);for(let f=0;f<v.length;f++)v[f]=(Math.random()*2-1)*Math.exp(-f/(e.sampleRate*1.5))}const G=e.createConvolver();G.buffer=V,E.gain.setValueAtTime(.3,t),o.connect(g),h.connect(g),A.connect(g),w.connect(g),g.connect(G),G.connect(E),E.connect(x),g.connect(x),x.connect(e.destination),g.gain.setValueAtTime(this.volume*.2,t);const I=e.createOscillator(),O=e.createGain();I.frequency.setValueAtTime(.08,t),O.gain.setValueAtTime(3,t),I.connect(O),O.connect(n.frequency);const S=e.createOscillator(),W=e.createGain();S.frequency.setValueAtTime(.05,t),W.gain.setValueAtTime(100,t),S.connect(W),W.connect(s.frequency);const C=e.createOscillator(),L=e.createGain();C.frequency.setValueAtTime(.03,t),L.gain.setValueAtTime(.02,t),C.connect(L),L.connect(w.gain),n.start(t),a.start(t),i.start(t),r.start(t),c.start(t),d.start(t),M.start(t),b.start(t),B.start(t),k.start(t),I.start(t),S.start(t),C.start(t),this.backgroundMusic={oscillators:[n,a,i,r,c,d,b,B,k,I,S,C],sources:[M],gainNode:g},console.log("‚úÖ Background music started (realistic instruments)")}catch(e){console.error("Error starting background music:",e)}}stopBackgroundMusic(){if(this.backgroundMusic){console.log("üîá Stopping background music...");try{const e=this.audioContext.currentTime;this.backgroundMusic.gainNode.gain.exponentialRampToValueAtTime(.001,e+1),setTimeout(()=>{if(this.backgroundMusic){if(this.backgroundMusic.source)try{this.backgroundMusic.source.stop()}catch{}this.backgroundMusic.oscillators&&this.backgroundMusic.oscillators.forEach(t=>{try{t.stop()}catch{}}),this.backgroundMusic.sources&&this.backgroundMusic.sources.forEach(t=>{try{t.stop()}catch{}}),this.backgroundMusic=null}},1e3),console.log("‚úÖ Background music stopped")}catch(e){console.error("Error stopping background music:",e),this.backgroundMusic=null}}}toggleBackgroundMusic(){return this.musicEnabled=!this.musicEnabled,this.musicEnabled?this.startBackgroundMusic():this.stopBackgroundMusic(),this.musicEnabled}isMusicPlaying(){return this.backgroundMusic!==null}isMusicEnabled(){return this.musicEnabled}}class ee{constructor(){this.chainManager=new _,this.accountManager=new D(this.chainManager),this.gameManager=new J(this.chainManager,this.accountManager),this.matchmakingManager=new j(this.chainManager,this.accountManager),this.transactionManager=new Y,this.uiManager=new K(this.gameManager),this.soundManager=new Z,this.timeoutTimer=null,this.timeoutStartTime=null,this.TIMEOUT_SECONDS=30,this.init()}init(){this.setupEventListeners(),this.uiManager.updateGameStats(this.gameManager.gameStats),setTimeout(()=>{this.uiManager.initializeChart()},100),setTimeout(()=>{this.handleConnect()},500)}setupEventListeners(){this.uiManager.elements.connectBtn.addEventListener("click",()=>this.handleConnect()),this.uiManager.elements.connectWalletBtn.addEventListener("click",()=>this.handleConnectWallet()),this.uiManager.elements.useSeedBtn.addEventListener("click",()=>this.uiManager.showSeedInput()),this.uiManager.elements.importSeedBtn.addEventListener("click",()=>this.handleImportSeed()),this.uiManager.elements.cancelSeedBtn.addEventListener("click",()=>this.uiManager.hideSeedInput()),this.uiManager.elements.playGameBtn.addEventListener("click",()=>this.handlePlayGame()),this.uiManager.elements.cancelMatchmakingBtn.addEventListener("click",()=>this.handleCancelMatchmaking()),this.uiManager.elements.resetGameBtn.addEventListener("click",()=>this.handleResetGame()),document.querySelectorAll(".cell").forEach(e=>{e.addEventListener("click",async t=>{await this.soundManager.resume(),this.soundManager.isMusicPlaying()||this.soundManager.startBackgroundMusic();const n=parseInt(t.target.getAttribute("data-cell"));this.handleCellClick(n)})}),this.uiManager.elements.clearHistoryBtn.addEventListener("click",()=>{this.transactionManager.clearHistory(),this.uiManager.renderTransactionHistory([]),this.uiManager.updatePendingCount(0),this.uiManager.updateChart([]),this.uiManager.updateTransactionStats(null)}),this.uiManager.elements.claimTimeoutBtn.addEventListener("click",()=>this.handleClaimTimeout()),document.getElementById("toggleSoundBtn").addEventListener("click",()=>this.handleToggleSound())}async handleConnect(){const e=this.uiManager.elements.rpcUrl.value.trim(),t=this.uiManager.elements.connectBtn;if(!e){alert("Please enter a valid RPC URL");return}try{t.textContent="Connecting...",t.disabled=!0,this.chainManager.isConnected()&&(console.log("Disconnecting from previous chain..."),await this.handleDisconnect()),await this.chainManager.connect(e);const n=await this.chainManager.getChainInfo();this.uiManager.updateConnectionStatus(!0,"Connected"),this.uiManager.showChainInfo(n.chain,n.version),this.uiManager.showBlockBanner(),await this.chainManager.subscribeToBlocks(async a=>{if(this.accountManager.isConnected())try{const i=await this.accountManager.getBalance();this.uiManager.updateBalance(i)}catch(i){console.error("Error updating balance:",i)}a&&(console.warn("Reloading game state due to detected fork..."),await this.handleResetGame(),await this.checkAndJoinActiveGame(),this.uiManager.showGameMessage("‚ö†Ô∏è Chain revert detected. Reloading game..."))}),this.gameManager.subscribeToGameEvents(async(a,i)=>{await this.handleGameEvent(a,i)}),t.textContent="Reconnect",t.disabled=!1,this.uiManager.elements.connectWalletBtn.disabled=!1,this.uiManager.elements.connectWalletBtn.classList.remove("disabled")}catch(n){console.error("Connection error:",n),alert(`Failed to connect: ${n.message}`),this.uiManager.updateConnectionStatus(!1,"Disconnected"),t.textContent="Connect",t.disabled=!1}}async handleDisconnect(){console.log("üîå Disconnecting and resetting state...");try{this.stopTimeoutTimer(),this.chainManager.stopBlockSubscription(),this.accountManager.stopBalanceUpdates(),this.gameManager.resetGame(),this.matchmakingManager.setInQueue(!1),this.transactionManager.clearHistory(),this.chainManager.api&&(await this.chainManager.api.disconnect(),this.chainManager.api=null),this.uiManager.hideGameBoard(),this.uiManager.hideGameMessage(),this.uiManager.hideMatchmakingWaiting(),this.uiManager.hideTimeoutSection(),this.uiManager.hideAccountInfo(),this.uiManager.hideGameWaitingOverlay(),this.uiManager.renderTransactionHistory([]),this.uiManager.updatePendingCount(0),this.uiManager.updateChart([]),this.uiManager.updateTransactionStats(null),this.uiManager.elements.connectWalletBtn.disabled=!0,this.uiManager.elements.connectWalletBtn.classList.add("disabled"),console.log("‚úÖ Disconnected and reset complete")}catch(e){console.error("Error during disconnect:",e)}}async handleConnectWallet(){try{const e=await this.accountManager.connectWallet();this.uiManager.updateAccountInfo(e.address,"extension"),this.accountManager.startBalanceUpdates(n=>{this.uiManager.updateBalance(n)});const t=await this.accountManager.getBalance();await this.checkAndMintFunds(t),await this.checkAndJoinActiveGame()}catch(e){console.error("Wallet connection error:",e),alert(e.message)}}async handleImportSeed(){const e=this.uiManager.elements.seedPhrase.value.trim();if(!e){alert("Please enter a seed string");return}try{const t=await this.accountManager.createFromSeed(e);this.uiManager.hideSeedInput(),this.uiManager.updateAccountInfo(t.address,"seed"),this.accountManager.startBalanceUpdates(a=>{this.uiManager.updateBalance(a)});const n=await this.accountManager.getBalance();await this.checkAndMintFunds(n),await this.checkAndJoinActiveGame()}catch(t){console.error("Seed import error:",t),alert(`Failed to create account: ${t.message}`)}}async handlePlayGame(){if(!this.chainManager.isConnected()||!this.accountManager.isConnected()){alert("Please connect to chain and wallet first");return}const e=this.uiManager.elements.playGameBtn;try{e.disabled=!0,e.textContent="JOINING QUEUE...",this.soundManager.playMatchmakingSound();const t=await this.matchmakingManager.joinQueue(),n=this.transactionManager.createTransaction("matchmaking",this.accountManager.getAddress(),"Matchmaking","Start Game"),a=await this.accountManager.signAndSend(t,async i=>{await this.handleTransactionStatus(i,n,a,s=>{console.log("Event data:",s),console.log("Event data type:",s.type),console.log("Event data reason:",s.reason),console.log("Event data status:",s.status),console.log("Event data status text:",s.statusText),console.log("Event data block hash:",s.blockHash),console.log("Event data finalized block hash:",s.finalizedBlockHash),console.log("Event data timing:",s.timing),console.log("Event data txData:",s.txData),s.type==="PlayerJoinedQueue"?this.uiManager.showMatchmakingWaiting():s.type==="GameCreated"?(this.uiManager.hideMatchmakingWaiting(),this.matchmakingManager.setInQueue(!1)):s.type==="ExtrinsicFailed"&&(console.error("Extrinsic failed:",s.reason),this.checkAndJoinActiveGame())})})}catch(t){console.error("Matchmaking error:",t),this.uiManager.hideMatchmakingWaiting(),alert(`Failed to join matchmaking: ${t.message}`),e.textContent="START GAME",e.disabled=!1}}async handleCancelMatchmaking(){try{const e=await this.matchmakingManager.cancelQueue(),t=await this.accountManager.signAndSend(e,n=>{n.status.isInBlock&&(this.uiManager.hideMatchmakingWaiting(),t())})}catch(e){console.error("Cancel matchmaking error:",e),alert(`Failed to cancel matchmaking: ${e.message}`)}}async checkAndMintFunds(e){if(!(!this.chainManager.isConnected()||!this.accountManager.isConnected()))try{const t=parseFloat(e);if(isNaN(t)||t===0){console.log("üí∞ Balance is 0, minting funds...");const n=this.transactionManager.createTransaction("mint_funds",this.accountManager.getAddress(),"Tic-Tac-Toe Pallet","Mint 1000 UNIT"),a=this.chainManager.api.registry.chainDecimals[0]||12,i=1e3*Math.pow(10,a),s=this.chainManager.api.tx.ticTacToe.mintFunds(this.accountManager.currentAccount.address,i),o=await this.accountManager.sendUnsigned(s,async r=>{await this.handleTransactionStatus(r,n,o)})}}catch(t){console.error("Error checking/minting funds:",t)}}async checkAndJoinActiveGame(){if(!(!this.chainManager.isConnected()||!this.accountManager.isConnected()))try{if(await this.matchmakingManager.isPlayerInQueue()){console.log("Player is in matchmaking queue, showing waiting UI"),this.uiManager.showMatchmakingWaiting();return}console.log("Checking for active game...");const t=await this.gameManager.getPlayerGame();if(console.log("Game found:",t),!t){console.log("No active game found");return}const[n,a]=t;console.log(`Auto-loading active game #${n}`,a),await this.setupAndShowGame(n,a.player_x.toString(),a.player_o.toString(),a);const i=this.gameManager.getGameInfo();console.log("Game auto-loaded. Active:",i.gameActive,"ID:",i.currentGameId)}catch(e){console.error("Error checking for active game:",e)}}async handleCellClick(e){const t=this.gameManager.getGameInfo();if(console.log("Cell clicked:",e,"Game info:",t),!t.gameActive){console.warn("Game not active!"),alert("Game is not active. Please start a game first.");return}if(t.gameBoard[e]!==null){console.warn("Cell already taken!");return}if(t.currentGameId===null||t.currentGameId===void 0){alert("Please start a game first");return}try{this.uiManager.showGameWaitingOverlay(),this.soundManager.playMoveSound();const n=await this.gameManager.makeMove(e),a=this.transactionManager.createTransaction("game_move",this.accountManager.getAddress(),`Game #${t.currentGameId}`,`Move at [${e}]`),i=await this.accountManager.signAndSend(n,async s=>{await this.handleTransactionStatus(s,a,i),(s.status.isInBlock||s.status.isFinalized)&&this.uiManager.hideGameWaitingOverlay()})}catch(n){console.error("Move error:",n),this.uiManager.hideGameWaitingOverlay(),alert(`Failed to make move: ${n.message}`)}}async handleResetGame(){if(this.stopTimeoutTimer(),this.gameManager.resetGame(),this.uiManager.hideGameBoard(),this.uiManager.hideGameMessage(),this.uiManager.hideMatchmakingWaiting(),this.uiManager.hideTimeoutSection(),this.uiManager.updateBoardFromState({board:Array(9).fill(null)}),await this.matchmakingManager.isPlayerInQueue()){console.log("Player is in matchmaking queue, showing waiting UI"),this.uiManager.showMatchmakingWaiting();return}}startTimeoutTimer(){console.log("‚è±Ô∏è Starting timeout timer (opponent's turn)"),this.stopTimeoutTimer(!1),this.timeoutStartTime=Date.now(),this.uiManager.showTimeoutSection(),this.uiManager.hideClaimTimeoutBtn(),this.timeoutTimer=setInterval(()=>{const e=Math.floor((Date.now()-this.timeoutStartTime)/1e3),t=Math.max(0,this.TIMEOUT_SECONDS-e);this.uiManager.updateTimeoutCountdown(t),t<=10&&t>0&&this.soundManager.playTimeoutWarning(),t===0&&(console.log("‚è±Ô∏è Timeout expired! Showing claim button"),clearInterval(this.timeoutTimer),this.timeoutTimer=null,this.uiManager.showClaimTimeoutBtn())},1e3)}stopTimeoutTimer(e=!0){this.timeoutTimer&&(console.log("‚è±Ô∏è Stopping timeout timer (your turn or game ended)"),clearInterval(this.timeoutTimer),this.timeoutTimer=null),this.timeoutStartTime=null,e&&this.uiManager.hideTimeoutSection()}async handleClaimTimeout(){if(this.gameManager.getGameInfo().currentGameId===null||this.gameManager.getGameInfo().currentGameId===void 0){alert("No active game");return}if(confirm("Claim victory due to opponent timeout?"))try{const t=await this.gameManager.claimTimeout(),n=this.transactionManager.createTransaction("claim_timeout",this.accountManager.getAddress(),`Game #${this.gameManager.getGameInfo().currentGameId}`,"Claim Timeout Victory"),a=await this.accountManager.signAndSend(t,async i=>{await this.handleTransactionStatus(i,n,a)});this.stopTimeoutTimer()}catch(t){console.error("Claim timeout error:",t),alert(`Failed to claim timeout: ${t.message}`)}}async handleGameEvent(e,t){switch(await this.gameManager.gameState.handleEvent(e,t),e){case"gameCreated":const n=this.accountManager.getAddress();if((t.playerX===n||t.playerO===n)&&this.matchmakingManager.isInQueue()){console.log("Matched! Loading game..."),this.uiManager.hideMatchmakingWaiting(),this.matchmakingManager.setInQueue(!1),this.soundManager.playGameStartSound();const s=this.gameManager.gameState;s.gameId!==null&&(this.uiManager.showGameBoard(),this.uiManager.updateGameInfo(s.gameId,s.playerX,s.playerO),!s.isMyTurn&&!s.isEnded&&this.startTimeoutTimer())}break;case"moveMade":const a=this.gameManager.gameState;if(a.isEnded){console.log("Game has ended, not starting timeout timer"),this.stopTimeoutTimer();break}a.isMyTurn?(console.log("It's my turn, stopping timeout"),this.stopTimeoutTimer()):(console.log("It's opponent's turn, starting timeout"),this.soundManager.playOpponentTurnSound(),this.startTimeoutTimer());break;case"gameEnded":const i=this.gameManager.handleGameEnd(t.state);i.winnerType==="winner"?this.soundManager.playWinSound():i.winnerType==="loser"&&this.soundManager.playLoseSound(),this.uiManager.showGameEndMessage(i.message,i.winnerType),this.uiManager.updateGameStats(i.stats);break}}async setupAndShowGame(e,t,n,a=null){try{console.log("Setting up game:",{gameId:e,playerX:t,playerO:n,hasExistingData:!!a});const i=await this.gameManager.setupGame(e,t,n,a);console.log("Setup result:",i),this.uiManager.showGameBoard(),this.uiManager.updateGameInfo(e,t,n);const s=this.gameManager.getGameInfo();if(console.log("Game info:",s),this.uiManager.updateGameStats(s.gameStats),i&&i.ended){this.stopTimeoutTimer();const r=this.gameManager.handleGameEnd(i.state);this.uiManager.showGameEndMessage(r.message,r.winnerType)}else{this.uiManager.hideGameMessage();const r=this.gameManager.gameState;r.isMyTurn?this.stopTimeoutTimer():r.isEnded||this.startTimeoutTimer()}const o=this.gameManager.getGameInfo();console.log("Game setup complete. Final game state:",o),o.gameActive?o.currentGameId===null||o.currentGameId===void 0?(console.error("WARNING: No game ID set after setup!"),console.error("Final state:",o),console.error("Passed game ID:",e),alert("Game setup completed but no game ID. Please try again.")):console.log("‚úì Game is ready to play!"):(console.error("WARNING: Game is not active after setup!"),console.error("Final state:",o))}catch(i){console.error("Setup game error:",i),console.error("Stack:",i.stack),alert(`Failed to setup game: ${i.message}`)}}async handleTransactionStatus(e,t,n,a){const{status:i,dispatchError:s}=e;if(i.isInvalid){t.timing.invalid=Date.now(),t.status="error",t.statusText="Invalid",this.updateTransactionUI(t),this.uiManager.hideGameWaitingOverlay();return}if(e.txHash&&!t.hash&&(t.hash=e.txHash.toHex()),i.isReady&&(t.timing.ready=Date.now(),t.statusText="Ready",this.updateTransactionUI(t)),i.isInBlock){if(t.timing.inBlock=Date.now(),t.status="success",t.statusText="In Block",t.blockHash=i.asInBlock.toHex(),this.updateTransactionUI(t),s){let o="";if(s.isModule){const r=this.chainManager.api.registry.findMetaError(s.asModule);o=`${r.section}.${r.name}`}else o=s.toString();this.uiManager.hideGameWaitingOverlay(),alert(`Transaction failed: ${o}`),n();return}try{const o=await this.chainManager.api.query.system.events.at(i.asInBlock);let r=!1,c="";for(const{event:d}of o){if(this.chainManager.api.events.system.ExtrinsicFailed.is(d)){r=!0;const[l,h]=d.data;if(l.isModule){const y=this.chainManager.api.registry.findMetaError(l.asModule);c=`${y.section}.${y.name}: ${y.docs.join(" ")}`}else c=l.toString()}a&&!r?(this.chainManager.api.events.ticTacToe.PlayerJoinedQueue.is(d)&&a({type:"PlayerJoinedQueue"}),this.chainManager.api.events.ticTacToe.GameCreated.is(d)&&a({type:"GameCreated"})):a&&r&&(console.error("SENDING Extrinsic failed:",c),a({type:"ExtrinsicFailed",reason:c})),r&&(t.status="error",t.statusText="Failed",this.updateTransactionUI(t),this.uiManager.hideGameWaitingOverlay(),setTimeout(()=>{this.uiManager.showGameMessage(c||"Transaction failed on chain")},50),n())}}catch(o){console.error("Error reading events:",o)}}i.isFinalized&&(t.timing.finalized=Date.now(),t.statusText="Finalized ‚úì",t.finalizedBlockHash=i.asFinalized.toHex(),this.updateTransactionUI(t),n())}updateTransactionUI(e){let t;this.transactionManager.getHistory().find(i=>i.id===e.id)?t=this.transactionManager.updateInHistory(e.hash||e.id,e):t=this.transactionManager.addToHistory(e),this.uiManager.renderTransactionHistory(t),this.uiManager.updatePendingCount(this.transactionManager.getPendingCount()),this.uiManager.updateChart(t);const a=this.transactionManager.calculateStats();this.uiManager.updateTransactionStats(a)}handleToggleSound(){const e=this.soundManager.toggleEnabled(),t=document.getElementById("soundOnIcon"),n=document.getElementById("soundOffIcon");e?(t.style.display="block",n.style.display="none",console.log("üîä Sound enabled")):(t.style.display="none",n.style.display="block",console.log("üîá Sound disabled"))}}document.addEventListener("DOMContentLoaded",()=>{window.app=new ee});
